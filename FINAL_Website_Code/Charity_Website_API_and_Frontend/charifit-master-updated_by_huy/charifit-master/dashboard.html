<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ªïng quan - Trang qu·∫£n tr·ªã</title>
    <link rel="stylesheet" href="css/dashboard_styles.css">
</head>

<body>
    <!-- Ph·∫ßn th·ªëng k√™ t·ªïng quan -->
    <div class="stats-container">
        <div class="stat-card">
            <h3>T·ªïng s·ªë chi·∫øn d·ªãch</h3>
            <div class="number" id="campaignNumber"></div>
            <div class="trend" id="campaignTrend"></div>
        </div>
        <div class="stat-card">
            <h3>T·ªïng s·ªë quy√™n g√≥p</h3>
            <div class="number" id="collectedAmount"></div>
            <div class="trend" id="collectedAmountTrend"></div>
        </div>
        <div class="stat-card">
            <h3>S·ªë ng∆∞·ªùi tham gia</h3>
            <div class="number" id="volunteerNumber"></div>
            <div class="trend" id="volunteerTrend"></div>
        </div>
        <div class="stat-card">
            <h3>D·ª± √°n ho√†n th√†nh</h3>
            <div class="number" id="finishedCampaignNumber"></div>
            <div class="trend" id="finishedCampaignTrend"></div>
        </div>
    </div>

    <!-- Layout 2 c·ªôt cho n·ªôi dung ch√≠nh -->
    <div class="grid-container">
        <!-- C·ªôt tr√°i: D·ª± √°n g·∫ßn ƒë√¢y -->
        <div class="section">
            <h2>D·ª± √°n g·∫ßn ƒë√¢y</h2>
            <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Goal Amount</th>
                        <th>Collected Amount</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Status</th>
                        <th>Created At</th>
                    </tr>
                </thead>
                <tbody id="campaignList"></tbody>
            </table>
        </div>

        <!-- C·ªôt ph·∫£i: Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y -->
        <div class="section">
            <h2>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h2>
            <table>
                <thead>
                    <tr>
                        <th>Admin ID</th>
                        <th>Action</th>
                        <th>Action Date</th>
                    </tr>
                </thead>
                <tbody id="adminLogList"></tbody>
            </table>
        </div>
    </div>
</body>
<script>
    const apiUrl = "http://vanesline.runasp.net/api/Campaign";

    document.addEventListener("DOMContentLoaded", () => {
        fetchCampaigns();
        fetchCollectedAmounts();
        fetchVolunteers();
        fetchFinishedCampaigns();
        fetchRecentlyCampaigns();
        fetchAdminLogs();
    });

    async function fetchCampaigns() {
        try {
            const response = await fetch(`${apiUrl}/GetList`);
            if (!response.ok) {
                throw new Error("L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API");
            }

            const campaigns = await response.json();
            const campaignNumber = document.getElementById("campaignNumber");
            const campaignTrend = document.getElementById("campaignTrend");

            if (campaignNumber) {
                campaignNumber.textContent = campaigns.length;
            }

            // L·∫•y th√°ng hi·ªán t·∫°i v√† th√°ng tr∆∞·ªõc
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;

            // H√†m ki·ªÉm tra m·ªôt chi·∫øn d·ªãch c√≥ thu·ªôc th√°ng n√†o kh√¥ng
            function isSameMonth(date, month, year) {
                return date.getMonth() === month && date.getFullYear() === year;
            }

            // L·ªçc c√°c chi·∫øn d·ªãch trong th√°ng hi·ªán t·∫°i v√† th√°ng tr∆∞·ªõc
            const currentMonthCampaigns = campaigns.filter(campaign => {
                const createdDate = new Date(campaign.cCreatedAt);
                return isSameMonth(createdDate, currentMonth, currentYear);
            });

            const lastMonthCampaigns = campaigns.filter(campaign => {
                const createdDate = new Date(campaign.cCreatedAt);
                return isSameMonth(createdDate, lastMonth, lastMonthYear);
            });

            const currentCount = currentMonthCampaigns.length;
            const lastCount = lastMonthCampaigns.length;
            const trendDifference = currentCount - lastCount;
            const trendPercentage = lastCount > 0 ? ((trendDifference / lastCount) * 100).toFixed(2) : 0;

            // Hi·ªÉn th·ªã trend
            if (campaignTrend) {
                if (trendDifference > 0) {
                    campaignTrend.innerHTML = `üìà +${trendPercentage}% <span style="color:green;">(TƒÉng ${trendDifference} chi·∫øn d·ªãch so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                } else if (trendDifference < 0) {
                    campaignTrend.innerHTML = `üìâ ${trendPercentage}% <span style="color:red;">(Gi·∫£m ${Math.abs(trendDifference)} chi·∫øn d·ªãch so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                } else {
                    campaignTrend.innerHTML = `‚ûñ 0% <span style="color:gray;">(Kh√¥ng thay ƒë·ªïi so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                }
            }
        } catch (error) {
            console.error("L·ªói:", error);
        }
    }

    async function fetchCollectedAmounts() {
        try {
            const response = await fetch(`${apiUrl}/GetList`);
            if (!response.ok) {
                throw new Error("L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API");
            }

            const donations = await response.json();
            const collectedAmount = document.getElementById("collectedAmount");
            const collectedAmountTrend = document.getElementById("collectedAmountTrend");

            // L·∫•y th√°ng hi·ªán t·∫°i v√† th√°ng tr∆∞·ªõc
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;

            // H√†m ki·ªÉm tra m·ªôt b·∫£n ghi c√≥ thu·ªôc th√°ng n√†o kh√¥ng
            function isSameMonth(date, month, year) {
                return date.getMonth() === month && date.getFullYear() === year;
            }

            // L·ªçc s·ªë ti·ªÅn quy√™n g√≥p theo th√°ng
            let totalCurrentMonth = 0;
            let totalLastMonth = 0;

            donations.forEach(donation => {
                const createdDate = new Date(donation.cCreatedAt);
                const amount = parseFloat(donation.cCollectedAmount) || 0; // ƒê·∫£m b·∫£o s·ªë h·ª£p l·ªá

                if (isSameMonth(createdDate, currentMonth, currentYear)) {
                    totalCurrentMonth += amount;
                } else if (isSameMonth(createdDate, lastMonth, lastMonthYear)) {
                    totalLastMonth += amount;
                }
            });

            // Hi·ªÉn th·ªã t·ªïng s·ªë ti·ªÅn quy√™n g√≥p
            if (collectedAmount) {
                collectedAmount.textContent = `${totalCurrentMonth.toLocaleString()} VND`;
            }

            // T√≠nh xu h∆∞·ªõng tƒÉng/gi·∫£m
            const trendDifference = totalCurrentMonth - totalLastMonth;
            const trendPercentage = totalLastMonth > 0 ? ((trendDifference / totalLastMonth) * 100).toFixed(2) : 0;

            // Hi·ªÉn th·ªã xu h∆∞·ªõng
            if (collectedAmountTrend) {
                if (trendDifference > 0) {
                    collectedAmountTrend.innerHTML = `üìà +${trendPercentage}% <span style="color:green;">(TƒÉng ${trendDifference.toLocaleString()} VND so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                } else if (trendDifference < 0) {
                    collectedAmountTrend.innerHTML = `üìâ ${trendPercentage}% <span style="color:red;">(Gi·∫£m ${Math.abs(trendDifference).toLocaleString()} VND so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                } else {
                    collectedAmountTrend.innerHTML = `‚ûñ 0% <span style="color:gray;">(Kh√¥ng thay ƒë·ªïi so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                }
            }
        } catch (error) {
            console.error("L·ªói:", error);
        }
    }

    const apiUrlVolunteer = "http://vanesline.runasp.net/Volunteer/GetList";

    async function fetchVolunteers() {
        try {
            const response = await fetch(apiUrlVolunteer);
            if (!response.ok) {
                throw new Error("L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API");
            }

            const volunteers = await response.json();
            const volunteerNumber = document.getElementById("volunteerNumber");
            const volunteerTrend = document.getElementById("volunteerTrend");

            // Hi·ªÉn th·ªã t·ªïng s·ªë t√¨nh nguy·ªán vi√™n
            if (volunteerNumber) {
                volunteerNumber.textContent = volunteers.length;
            }

            // L·∫•y th√°ng hi·ªán t·∫°i v√† th√°ng tr∆∞·ªõc
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;

            // H√†m ki·ªÉm tra m·ªôt b·∫£n ghi c√≥ thu·ªôc th√°ng n√†o kh√¥ng
            function isSameMonth(date, month, year) {
                return date.getMonth() === month && date.getFullYear() === year;
            }

            // L·ªçc s·ªë t√¨nh nguy·ªán vi√™n theo th√°ng
            const currentMonthVolunteers = volunteers.filter(volunteer => {
                const createdDate = new Date(volunteer.vAppliedAt);
                return isSameMonth(createdDate, currentMonth, currentYear);
            });

            const lastMonthVolunteers = volunteers.filter(volunteer => {
                const createdDate = new Date(volunteer.vAppliedAt);
                return isSameMonth(createdDate, lastMonth, lastMonthYear);
            });

            const currentCount = currentMonthVolunteers.length;
            const lastCount = lastMonthVolunteers.length;
            const trendDifference = currentCount - lastCount;
            const trendPercentage = lastCount > 0 ? ((trendDifference / lastCount) * 100).toFixed(2) : 0;

            // Hi·ªÉn th·ªã xu h∆∞·ªõng
            if (volunteerTrend) {
                if (trendDifference > 0) {
                    volunteerTrend.innerHTML = `üìà +${trendPercentage}% <span style="color:green;">(TƒÉng ${trendDifference} t√¨nh nguy·ªán vi√™n so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                } else if (trendDifference < 0) {
                    volunteerTrend.innerHTML = `üìâ ${trendPercentage}% <span style="color:red;">(Gi·∫£m ${Math.abs(trendDifference)} t√¨nh nguy·ªán vi√™n so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                } else {
                    volunteerTrend.innerHTML = `‚ûñ 0% <span style="color:gray;">(Kh√¥ng thay ƒë·ªïi so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                }
            }
        } catch (error) {
            console.error("L·ªói:", error);
        }
    }

    async function fetchFinishedCampaigns() {
        try {
            const response = await fetch(`${apiUrl}/GetList`);
            if (!response.ok) {
                throw new Error("L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ API");
            }

            const campaigns = await response.json();
            const finishedCampaignNumber = document.getElementById("finishedCampaignNumber");
            const finishedCampaignTrend = document.getElementById("finishedCampaignTrend");

            // L·ªçc danh s√°ch chi·∫øn d·ªãch ƒë√£ ho√†n th√†nh
            const finishedCampaigns = campaigns.filter(campaign => {
                return parseFloat(campaign.cCollectedAmount) >= parseFloat(campaign.cGoalAmount);
            });

            // Hi·ªÉn th·ªã t·ªïng s·ªë chi·∫øn d·ªãch ƒë√£ ho√†n th√†nh
            if (finishedCampaignNumber) {
                finishedCampaignNumber.textContent = finishedCampaigns.length;
            }

            // L·∫•y th√°ng hi·ªán t·∫°i v√† th√°ng tr∆∞·ªõc
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;

            // H√†m ki·ªÉm tra m·ªôt b·∫£n ghi c√≥ thu·ªôc th√°ng n√†o kh√¥ng
            function isSameMonth(date, month, year) {
                return date.getMonth() === month && date.getFullYear() === year;
            }

            // L·ªçc s·ªë chi·∫øn d·ªãch ho√†n th√†nh theo th√°ng
            const currentMonthFinished = finishedCampaigns.filter(campaign => {
                const createdDate = new Date(campaign.cCreatedAt);
                return isSameMonth(createdDate, currentMonth, currentYear);
            });

            const lastMonthFinished = finishedCampaigns.filter(campaign => {
                const createdDate = new Date(campaign.cCreatedAt);
                return isSameMonth(createdDate, lastMonth, lastMonthYear);
            });

            const currentCount = currentMonthFinished.length;
            const lastCount = lastMonthFinished.length;
            const trendDifference = currentCount - lastCount;
            const trendPercentage = lastCount > 0 ? ((trendDifference / lastCount) * 100).toFixed(2) : 0;

            // Hi·ªÉn th·ªã xu h∆∞·ªõng
            if (finishedCampaignTrend) {
                if (trendDifference > 0) {
                    finishedCampaignTrend.innerHTML = `üìà +${trendPercentage}% <span style="color:green;">(TƒÉng ${trendDifference} chi·∫øn d·ªãch so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                } else if (trendDifference < 0) {
                    finishedCampaignTrend.innerHTML = `üìâ ${trendPercentage}% <span style="color:red;">(Gi·∫£m ${Math.abs(trendDifference)} chi·∫øn d·ªãch so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                } else {
                    finishedCampaignTrend.innerHTML = `‚ûñ 0% <span style="color:gray;">(Kh√¥ng thay ƒë·ªïi so v·ªõi th√°ng tr∆∞·ªõc)</span>`;
                }
            }
        } catch (error) {
            console.error("L·ªói:", error);
        }
    }

    // H√†m format s·ªë v·ªõi d·∫•u ch·∫•m ngƒÉn c√°ch h√†ng ngh√¨n
    function formatNumber(number) {
        if (number == null) return "0";
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    async function fetchRecentlyCampaigns() {
        const response = await fetch(`${apiUrl}/GetList`);
        const campaigns = await response.json();
        const campaignList = document.getElementById("campaignList");

        // S·∫Øp x·∫øp danh s√°ch theo `cCreatedAt` t·ª´ m·ªõi nh·∫•t ƒë·∫øn c≈© nh·∫•t
        const sortedCampaigns = campaigns.sort((a, b) => new Date(b.cCreatedAt) - new Date(a.cCreatedAt));

        // L·∫•y 3 b·∫£n ghi m·ªõi nh·∫•t
        const latestCampaigns = sortedCampaigns.slice(0, 3);

        // Hi·ªÉn th·ªã danh s√°ch l√™n b·∫£ng
        campaignList.innerHTML = latestCampaigns.map(campaign => `
        <tr>
            <td>${campaign.cTitle}</td>
            <td>${formatNumber(campaign.cGoalAmount)}</td>
            <td>${formatNumber(campaign.cCollectedAmount)}</td>
            <td>${campaign.cStartDate}</td>
            <td>${campaign.cEndDate}</td>
            <td>${campaign.cStatus}</td>
            <td>${new Date(campaign.cCreatedAt).toLocaleDateString()}</td>
        </tr>
    `).join("");
    }

    const apiUrlAdminLog = "http://vanesline.runasp.net/AdminLog";

    async function fetchAdminLogs() {
        const response = await fetch(`${apiUrlAdminLog}/GetList`);
        const adminLogs = await response.json();
        const adminLogList = document.getElementById("adminLogList");

        // S·∫Øp x·∫øp danh s√°ch theo `aActionDate` t·ª´ m·ªõi nh·∫•t ƒë·∫øn c≈© nh·∫•t
        const sortedAdminLogs = adminLogs.sort((a, b) => new Date(b.aActionDate) - new Date(a.aActionDate));

        // L·∫•y 3 b·∫£n ghi m·ªõi nh·∫•t
        const latestAdminLogs = sortedAdminLogs.slice(0, 3);

        adminLogList.innerHTML = latestAdminLogs.map(adminLog => `
        <tr>
            <td>${adminLog.aAdminId}</td>
            <td>${adminLog.aAction}</td>
            <td>${adminLog.aActionDate}</td>
        </tr>
    `).join("");
    }
</script>

</html>